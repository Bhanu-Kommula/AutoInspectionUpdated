<!DOCTYPE html>
<html>
<head>
    <title>500 Error Diagnosis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-item { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .loading { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; }
        .error-details { font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîß 500 Error Diagnosis Tool</h1>
    <p>Diagnosing the specific 500 Internal Server Error in postings service.</p>
    
    <div id="results"></div>
    
    <button onclick="diagnose500Error()">üöÄ Diagnose 500 Error</button>
    <button onclick="testDealerHealthFix()">üîß Test Dealer Health Fix</button>
    
    <script>
        const API_BASE = 'https://api-gateway-rn0i.onrender.com';
        const TEST_DEALER_EMAIL = 'bhanu@gmail.com';
        const resultsDiv = document.getElementById('results');
        
        function addResult(name, status, message, data = null, isLoading = false) {
            const div = document.createElement('div');
            let className = 'test-item ';
            if (isLoading) className += 'loading';
            else if (status === null) className += 'warning';
            else className += status ? 'success' : 'error';
            
            div.className = className;
            div.innerHTML = `
                <h3>${isLoading ? 'üîÑ' : (status === null ? '‚ö†Ô∏è' : (status ? '‚úÖ' : '‚ùå'))} ${name}</h3>
                <p><strong>Status:</strong> ${message}</p>
                ${data ? `<div class="error-details">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</div>` : ''}
            `;
            resultsDiv.appendChild(div);
            return div;
        }
        
        async function testEndpointWithDetails(name, url, options = {}) {
            const loadingDiv = addResult(name, false, 'Testing...', null, true);
            
            try {
                console.log(`üîß Testing: ${name} -> ${url}`);
                
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                loadingDiv.remove();
                
                let responseData;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                };
                
                addResult(
                    name, 
                    response.ok, 
                    `${response.status} - ${response.statusText}`, 
                    result
                );
                
                return { success: response.ok, response: result };
            } catch (error) {
                loadingDiv.remove();
                console.error(`‚ùå ${name}:`, error);
                addResult(name, false, error.message, { error: error.toString() });
                return { success: false, error: error.message };
            }
        }
        
        async function diagnose500Error() {
            resultsDiv.innerHTML = '<h2>üîÑ Diagnosing 500 Internal Server Error...</h2>';
            
            // 1. Test basic health endpoints first
            await testEndpointWithDetails('Gateway Health', `${API_BASE}/health`);
            await testEndpointWithDetails('Postings Service Health', `${API_BASE}/api/v1/health`);
            
            // 2. Test the exact failing endpoint with minimal data
            await testEndpointWithDetails('Posts by Email (Minimal Test)', `${API_BASE}/api/v1/posts-by-email`, {
                method: 'POST',
                body: JSON.stringify({ email: 'test@example.com' })
            });
            
            // 3. Test with actual dealer email
            await testEndpointWithDetails('Posts by Email (Real Email)', `${API_BASE}/api/v1/posts-by-email`, {
                method: 'POST',
                body: JSON.stringify({ email: TEST_DEALER_EMAIL })
            });
            
            // 4. Test counter offers endpoint
            await testEndpointWithDetails('Counter Offers Pending', 
                `${API_BASE}/api/v1/counter-offers/pending/${TEST_DEALER_EMAIL}`);
            
            // 5. Test GET endpoints (should be simpler)
            await testEndpointWithDetails('All Posts GET', `${API_BASE}/api/v1/post`);
            
            // 6. Test direct postings service (bypass gateway)
            await testEndpointWithDetails('Direct Postings Health', 'https://postings-service.onrender.com/health');
            await testEndpointWithDetails('Direct Posts by Email', 'https://postings-service.onrender.com/posts-by-email', {
                method: 'POST',
                body: JSON.stringify({ email: TEST_DEALER_EMAIL })
            });
        }
        
        async function testDealerHealthFix() {
            resultsDiv.innerHTML = '<h2>üîß Testing Dealer Service Health Endpoints...</h2>';
            
            // Test different possible health endpoints for dealer service
            const healthEndpoints = [
                '/health',
                '/api/dealers/health', 
                '/actuator/health',
                '/api/health'
            ];
            
            for (const endpoint of healthEndpoints) {
                await testEndpointWithDetails(
                    `Dealer Health: ${endpoint}`, 
                    `${API_BASE}${endpoint}`
                );
            }
            
            // Test direct dealer service
            await testEndpointWithDetails('Direct Dealer Service Health', 
                'https://dealer-service-v3ir.onrender.com/health');
        }
        
        // Auto-run diagnosis
        setTimeout(diagnose500Error, 1000);
    </script>
</body>
</html>
